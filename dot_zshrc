# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
type direnv >/dev/null && emulate zsh -c "$(direnv export zsh)"
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi
type direnv >/dev/null && emulate zsh -c "$(direnv hook zsh)"

# go
GOPATH=$HOME/.local/go
PATH=$GOPATH/bin:$PATH

# rust
CARGO_HOME=$HOME/.local/cargo
PATH=$CARGO_HOME/bin:$PATH

# poetry
POETRY_HOME=$HOME/.local/poetry
PATH=$POETRY_HOME/bin:$PATH

# pnpm
PNPM_HOME=$HOME/.local/share/pnpm
PATH="$PNPM_HOME:$PATH"

# cuda
CUDA_HOME=/usr/local/cuda
CUDA_INCLUDE_PATH=$CUDA_HOME/include
PATH=$CUDA_HOME/bin:$CUDA_INCLUDE_PATH:$PATH

# rocm
PATH=/opt/rocm/bin:$PATH

# mamba
MAMBA_EXE=$HOME/.local/bin/micromamba
MAMBA_ROOT_PREFIX=$HOME/micromamba

# General
ZDOTDIR=${ZDOTDIR:-$HOME}
PATH=$HOME/.local/bin:$PATH
HISTFILE=$HOME/.zsh_history
HISTIGNORE="*sudo -S*"
PROMPT_EOL_MARK=""   # don't add newline at the end of prompt
SAVEHIST=100000
EDITOR="nvim"

# Zsh options
setopt extendedhistory      # save timestamps in history
setopt histignoredups       # ignore consecutive dups in history
setopt histignorespace      # ignore spaces in history
setopt histfindnodups       # backwards search produces diff result each time
setopt histreduceblanks     # compact consecutive white space chars
setopt histnostore          # don't store history related functions
setopt incappendhistory     # incrementally add items to HISTFILE
setopt extendedglob         # use extended globbing (#, ~, ^)
setopt listpacked           # variable col widths
setopt histexpiredupsfirst  # delete duplicates first when HISTFILE size exceeds HISTSIZE
unsetopt beep               # don't beep 

# Load plugins & add custom styles
source "$ZDOTDIR"/.config/antidote/antidote.zsh
zstyle ':antidote:bundle' file "$ZDOTDIR"/.zsh_plugins
zstyle ':completion:*:git-checkout:*' sort false # disable sort when completing `git checkout`
zstyle ':completion:*:descriptions' format '[%d]' # set descriptions format to enable group support
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}" # set list-colors to enable filename colorizing
if type eza >/dev/null; then
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath' # preview directory's content with exa when completing cd
zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'eza -1 --color=always $realpath' 
else
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls -1 $realpath' 
zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls -1  $realpath' 
fi
zstyle ':fzf-tab:*' switch-group ',' '.' # switch group using `,` and `.`
type antidote >/dev/null && antidote load

# Load completions paths
autoload -Uz compinit; compinit
autoload -Uz promptinit; promptinit
autoload -Uz bashcompinit; bashcompinit
autoload -Uz bracketed-paste-magic
autoload -Uz url-quote-magic
zle -N bracketed-paste bracketed-paste-magic
zle -N self-insert url-quote-magic

# Prompt theme
prompt powerlevel10k

# Load zoxide
type zoxide >/dev/null && eval "$(zoxide init zsh)"

# Additional completions
type kubectl >/dev/null && source <(kubectl completion zsh)
type docker >/dev/null && source <(docker completion zsh)
type helm >/dev/null && source <(helm completion zsh)
type flux >/dev/null && source <(flux completion zsh)
type terraform >/dev/null && complete -o nospace -C /usr/bin/terraform terraform

# Custom Bindings
bindkey "^[[1;3D" backward-word
bindkey "^[[1;3C" forward-word
bindkey "^[[A" history-substring-search-up
bindkey "^[[B" history-substring-search-down
bindkey "^I"   complete-word       
bindkey "^[f" autosuggest-accept

# Load aliases & functions
[[ -f "$ZDOTDIR"/.zsh_aliases ]] && source "$ZDOTDIR"/.zsh_aliases
[[ -f "$ZDOTDIR"/.zsh_functions ]] && source "$ZDOTDIR"/.zsh_functions

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ -f "$ZDOTDIR"/.p10k.zsh ]] && source "$ZDOTDIR"/.p10k.zsh

# >>> mamba initialize >>>
__mamba_setup="$("$MAMBA_EXE" shell hook --shell zsh --root-prefix "$MAMBA_ROOT_PREFIX" 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__mamba_setup"
else
    alias micromamba="$MAMBA_EXE"  # Fallback on help from mamba activate
fi
unset __mamba_setup
# <<< mamba initialize <<<
